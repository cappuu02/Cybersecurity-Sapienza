# Hacking Windows – Summary

## Windows Security Issues
Windows vulnerabilities arise from backward compatibility, feature proliferation, and widespread use. Attackers exploit weak configurations, focusing on network services, kernel drivers, and applications. Major exploits include Code Red, Nimda, Slammer, and EternalBlue.

## Unauthenticated Attacks

### Four Vectors 
- Authentication Spoofing (password)
- Network Services
- Client Software Vulnerabilities
- Device Drivers

>Protect weakness in these areas

#### Authentication Spoofing Attacks
Hackers target authentication spoofing, network services, client software vulnerabilities, and device drivers. Common exploits involve SMB (TCP 445, 139), MSRPC (TCP 135), Terminal Services (TCP 3389), SQL (TCP 1433), and SharePoint (TCP 80, 443). Tools like Cain and SMBRelay enable credential theft through sniffing and MITM attacks. Pass-the-Hash and Pass-the-Ticket techniques allow access without cracking passwords.

**Password Guessing from the CL**
![[ETH/Images/27.png]]

**A password Guessing Script**
![[28.png]]
![[29.png]]
#### Password Guessing Countermeasures
Restrict SMB access using network firewalls and Windows security features like IPSec filters and Windows Firewall. Disabling SMB services further reduces risk. Enforce strong passwords and account lockout policies, ensuring they apply to the Administrator account. Enable logon failure auditing and regularly review event logs for suspicious activity. Combining these measures enhances defense in depth.


### Security Policy
![[30.png]]

### Audit Policy
Use a log analysis tool to check the logs `Microsoft Dumpel (Windows 2000 Resource Kit)`
	`C:\> dumpel -e 529 –f seclog.txt -l security –n Security -t`
For even better security, use Intrusion Detection/Intrusion Prevention software

![[2Semester/ETH/Images/52.png]]

### Unauthenticated Attacks (Authenticated Spoofing)
Remote password guessing
- Main target
- Automatic guessing on the CLI
- Automatic guessing on GUI of terminal service/remote desktop Services

### Eavesdropping on Network Password Exchange
You can sniff LAN Manager (LM) password challenge-response hashes with Cain (most
used).

![[31.png]]

### Kerberos
![[2Semester/ETH/Images/54.png]]

#### Kerberos sniffing
Kerberos 5 sends a preauthentication packet which contains a timestamp encrypted with a
key derived from the user's password.
- Offline attack on that exchange can reveal a weak password
- Cain has an MSKerb5-PreAuth packet sniffer
There's no simple defense against this, except using long, complex, passwords

![[33.png]]

### Unauthenticated Attacks (Windows Authentication Sniffing Countermeasures)
Disable LM authentication. NT LAN Manager (NTLM) hashes are harder to crack. Dictionary
attacks
- Pick good passwords (password complexity features)
- Do not allow dictionary password
- Use public key encryption
- Use built-in Windows IPsec to authenticate and encrypt traffic

### Unauthenticated Attacks (Eavesdropping on Network Password Exchange)
Three authentication protocols: LM (LAN Manager) (with hash), NTLM (with encryption),
Kerberos (with private or optional public key encryption)
-  Attack tools: Cain, LCP, L0phtcrack, KerbSniff
- Sniffing, brute-force cracking, dictionary cracking
- To sniff on a switched network: ARP spoofing/poisoning to redirect traffic through attackers

### Man in the Middle Attacks
SMBRelay and SMBProxy pass authentication hashes along, to get authenticated access to
the server.
- SMB Credential Reflection Attack
- SMB Credential Forwarding Attack

![[2Semester/ETH/Images/55.png]]

#### CAIN
Cain: ARP Poisoning, downgrade Auth versions
Can sniff Remote Desktop sessions, breaking their encryption (For Windows XP and Windows Server 2003)

#### Countermeasures
If attacker is already on your LAN, very hard
Use authenticated and encrypted protocols
Enforce them with Group Policy and firewall rules
Verify identity of remote servers with strong authentication or trusted third parties

### Unauthenticated Attacks (Man-in-the-Middle Attacks (MITM))
Man-in-the-Middle (MITM) attacks intercept authentication exchanges to gain unauthorized access. SMBRelay captures credentials from SMB traffic, while ARP spoofing and DNS redirection trick victims into connecting to malicious servers. Tools like Cain and SMBRelay3 facilitate these attacks by downgrading authentication protocols. Countermeasures include enforcing encryption, strong authentication, and disabling NetBIOS in favor of DNS.

### Pass-the-Hash
1. Compromise a machine
2. Dump password hashes stored in RAM
3. Use them as credentials for network services without cracking them
- Allow to compromise the Windows domain after compromising a single machine.
- Administrator logged into the compromised machine BEFORE the compromise, also taken

### Windows Credential Editor
![[34.png]]
![[35.png]]

### Passwords are Encrypted
![[36.png]]

### Pass-the-Ticket for Kerberos
Dump existing Kerberos RAM tickets and re- use them . WCE can replay and re-use tickets, but must compromise a host first

**Countermeasures**
NTLM is vulnerable by design; no fix available Prevent intrusions in the first place, since this
is a post-exploitation technique. If possible, use two-factor authentication.

### Unauthenticated Attacks (Pass-the-Hash)
Use LM and/or NTLM hash of a user’s password
-  No need to crack/brute-force the hash to cleartext password
- Allows to gain authorized access
- Limitations: Not all functionalities of the protocol are implemented
- Dump/modify NTLM credentials stored in memory and replay
-  Windows Credentials Editor (WCE)
-  Pass the ticket for Kerberos.
- WCE: dump Windows Kerberos tickets and reuse them

## Remote Unauthenticated Exploits
- Flaws or misconfigurations in Windows software itself
	- TCP/UDP services → driver interface, user-mode applications (MS Office, Internet Explorer, Adobe Acrobat Reader)
- Metaexploit
	- Framework plus archive of exploit modules
	- Locate/search the exploit module
	- Customize exploit parameters (vendor and model of victim software), payloads (remote command shell, users, injecting prebuilt code), and options (target IP address, IDS evasion, etc.)

### Metasploit
- Easily exploits network services
- Typically a couple of months behind Microsoft alerts
- CORE IMPACT and Canvas are expensive, but better

>Metasploit includes the Print Pooler Service vulnerability exploit, used by stuxnet to attack an iranian nuclear reactor

### Network Service Exploit Countermeasures
Apply patches quickly
Use workarounds for unpatched vulnerabilities:
- disable weak services,…
- Audit, Log and monitor traffic
-  Have an incident response plan: Computer Security Incident Response Team (CSIRT), a group include information security and general IT staff, representatives legal, human resources and public relations departments. Produce plan with the organization's response to a cyberattack.

### End-user Application Exploits
End users the weakest link. Less professional on security, Poorly managed rich software
ecosystem
- Worst Offenders:
	Adobe Flash Player in browser. Display of rich media and animated content over Internet
-  Adobe PDF Reader
Metaexploit (search /w adobe flash)

>Adobe flash VUlnerability

### End-user Application Exploits
Countermeasures
- Use a firewall to limit outbound connections
- Patches
- Antivirus, particularly on email-attach
- Run with least privilege; if browsing Internet, never as Administrator
-  Use software security options, such as read email in plaintext
-  Configure MS Office to very high macro security

### Device Driver Exploits
There were buffer overflows in wireless device drivers for MS
It is possible to own every vulnerable machine in range just with a beacon frame
NO connection required by the victim

## Unauthenticated Attacks  
### Device Driver Exploits  
- Windows wireless: within physical proximity to a rogue access point beaconing malicious packets  
- MS Plug and play compatibility  
	-  Vast number of vendor drivers  
- Execution in highly privileged kernel mode → one weak driver implies total compromise  
- Metaexploit WiFi exploit modules: e.g. oversized wireless beacon frame → remote code execution  

### Driver Exploit Countermeasures  
- Apply vendor patches  
- Disable wireless networking at high concentration of APs, and other high-risk environments 
- Use driver signing (trusted signatures on kernel-mode software). But does Microsoft really thoroughly test drivers? Eternal Blu?  
- "Future" User-Mode Driver Framework (UMDF)  
	  - Now adopted (V2)  

### User-Mode Driver Framework  
**User-Mode Driver Framework (UMDF)** is a device-driver development platform first introduced with Microsoft's Windows system, and is also available for Windows XP. It facilitates the creation of drivers for certain classes of devices.  

Standard device drivers can be difficult to write because they must handle a very wide range of system and device status as well as multiple additional software environments. Badly written device drivers can cause severe damage to a system (e.g., BSoD or DDoS).  


## Authenticated Attacks  

### Privilege Escalation  
- Once a user can log on to a Windows machine as a Guest or Limited User, the next goal is to escalate privileges to Administrator or SYSTEM  
  – `getadmin.exe` was an early exploit (DLL injection)  
  – There have been many others, including a **buffer overrun** MS03-013  

### SYSTEM Status  
The SYSTEM account is more powerful than the Administrator account. The Administrator can schedule tasks to be performed as SYSTEM. It's more complicated in Vista, but still possible.  

![[2Semester/ETH/Images/56.png]]

### Preventing Privilege Escalation
- Keep Win machines patched
- Restrict interactive logon to trusted accounts
	- Run Security Policy applet, secpol.msc
	- Local Policies → User Right Assignment → Deny log on locally

### Extracting and Cracking Passwords
Once Administrator-equivalent status has been obtained on one machine. Attackers often want to penetrate deeper into the network, so they want passwords. Post-exploitation: Disable Windows firewall.`

### Grabbing the Password Hashes
- Local Users in the Windows Security Accounts Manager (SAM) under NT4 and earlier
- Domain in the Active Directory (Windows 2000 and greater) domain controllers (DCs)    
- The SAM contains the usernames and hashed passwords of all users  
	- The counterpart of the `/etc/passwd` file from the UNIX world

### Obtaining the Hashes

- NT4 and earlier stores password hashes in `%systemroot%\system32\config\SAM`  
    – It's locked as long as the OS is running  
    – Also in the Registry key `HKEY_LOCAL_MACHINE\SAM`
    
- On Windows 2000 and greater domain controllers, password hashes are kept in Active Directory (`%windir%\WindowsDS\ntds.dit`)

### How to Get the Hashes
- Easy way: Just use Cain
- Cracker tab, right-click, "Add to List"

### How Cain Works
- Injects a DLL into a highly privileged process in a running system
- That's how pwdump, Cain, and Ophcrack do it

### Other Ways to Get the Hashes
- Boot the target system to an alternate OS and copy the files to removable media
- Copy the backup of the SAM file created by the Repair Disk Utility
    - But this file is protected by SYSKEY encryption, which makes it harder to crack (perhaps impossible)
- Sniff Windows authentication exchanges



### pwdump2 Countermeasures
- There is no defense against pwdump2, 3, 4, Cain, Ophcrack, etc.
- But the attacker needs local Administrative rights to use them.


### Cracking Passwords
- The hash is supposed to be really difficult to reverse
    - NTLM hashes are really hard to break
    - But Windows XP and earlier still use LM Hashes for backwards compatibility, in addition to NTLM hashes
    - They are turned off by default in Vista & Win 7

### No Salt!
To make hashing stronger, add a random "Salt" to a password before hashing it. Windows doesn't salt its hash! Two accounts with the same password hash to the same result, even in Windows 7 Beta! This makes it possible to speed up password cracking with precomputed Rainbow Tables.


### Demonstration
Two accounts on a Windows 7 Beta machine with the password 'password':

|User Name|LM Hash|NT Hash|
|---|---|---|
|Testuser|8846F7EAEE8FB117AD06BDD830B7586C|AAD3B43...|
|Testuser2|8846F7EAEE8FB117AD06BDD830B7586C|AAD3B43...|

### Linux Salts its Hashes
![[2Semester/ETH/Images/57.png]]




## NTLM Uses MD4 Hashing
The NTLM response is calculated as follows:
![[2Semester/ETH/Images/58.png]]



## Types of Hashes
All fast hashes are WRONG for passwords (SHA, MD, CRC). You need a SLOW algorithm. Ubuntu & Mac OS X hash thousands of times.

## Brute Force v. Dictionary
- **Brute Force**: Tries all possible combinations of characters.
- **Dictionary**: Tries words in a word list (e.g., able, baker, cow) and variations (@b13, Able).


## Password-Cracking Countermeasures
Strong passwords - not dictionary words, long, complex. Add non-printable ASCII characters like `(NUM LOCK)ALT255` or `(NUM LOCK)ALT-129`.


## Ways to Speed Cracks
- Rainbow tables trade time for memory with precomputed hashes.
- **Elcomsoft Distributed Password Recovery**: Uses many machines and graphics cards to make cracking 100x faster.

## Authenticated Attacks: Cracking Passwords
- Hashing – one-way encipherment.
- Offline password guessing: Compare hashes from `pwdump` with precomputed values.
- Tools:
    - CLI: John The Ripper Jumbo
    - GUI: LCP, Cain, Ophcrack, Elcomsoft.

## Dumping Cached Password
- Local Security Authority (LSA) Secrets: Contains unencrypted logon credentials under `HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets`.
- Service account passwords in _plaintext_, cached password hashes, FTP/web passwords.

## Dumping Cached Passwords
Local Security Authority (LSA) Secrets contains unencrypted logon credentials for external systems, is available under the Registry subkey of HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets, and is encrypted when the machine is off but decrypted and retained in memory after login.


## Contents of LSA Secrets
Service account passwords in plaintext include accounts in external domains, cached password hashes of the last ten users to log on to a machine, FTP and web-user plaintext passwords, Remote Access Services (RAS) dial-up account names and passwords, and computer account passwords for domain access.


## Previous Logon Cache Dump
- If a domain member cannot reach the domain controller, it performs an offline logon with cached credentials
- The last ten domain logons are stored in the cache, in an encrypted and hashed form
- The tool CacheDump can reverse the encryption and get the hashed passwords

## CacheDump Results
![[2Semester/ETH/Images/59.png]]

**CacheDump Results**
John the Ripper can crack these hashes with brute-force and dictionary attacks

![[2Semester/ETH/Images/60.png]]


## Windows Credential Editor
Extracts cleartext login password from RAM, requires no hash-cracking, but you only get currently logged-on users or sometimes users who were logged on but have now logged off.

## Previous Logon Cache Dump Countermeasures
There's not much you can do, as Microsoft offers a patch but it doesn't help much, according to Microsoft KB Article ID Q184017. You need Administrator or SYSTEM privileges to get the hashes, so it's important to avoid getting admin-ed in the first place.

## Previous Logon Cache Dump Countermeasures
Local Admin rights can lead to compromise of other accounts. To mitigate this, avoid using high-privileged domain accounts to log on to local machines (e.g., to start services), and Domain Admins should avoid RDP connections. You can change the Registry value to eliminate the cached credentials, but then users won't be able to log in when a domain controller is not accessible.

## Remote Control and Back Doors
Back doors are services enabling remote control, such as command-line remote control tools like Netcat for Windows. You can use this syntax to listen on port 8080 and execute cmd, and add –d for stealth mode (no interactive console). Obviously, this is very dangerous—remote control with no logon.

## Connecting to the nc Listener
On another machine connect with
- TELNET IP 8080
- You get a shell on the other machine

## PsExec et al.
SMB on TCP 139 or 445
-  From SysInternals (Microsoft.com)
- Allows remote code execution (with a username and password)
- Metaexploit Framework: a large array of backdoor payloads to spawn command-line shells bound to listening ports, etc.

## Graphical Remote Control
The Windows Built-in Terminal Services (aka Remote Desktop) listens on port 3389, but it's not on by default. Virtual Network Control (VNC) is free and widely used for graphic remote control, can easily be installed remotely, and can edit the remote registry for stealthy startup.



## Port Redirection
![[2Semester/ETH/Images/61.png]]


## Port Redirection
![[2Semester/ETH/Images/62.png]]



## Covering Tracks
Once intruders have Administrator or SYSTEM-
equivalent privileges, they will:
- Hide evidence of intrusion
- Install backdoors
- Hide a toolkit to use for regaining control in the future and to use against other systems


## Disabling Auditing
The auditpol /disable command will stop auditing will turn it back on• Auditpol /enable again
- Auditpol is included in Vista
- Part of the Resource Kit for earlier versions (XP, NT, 2000 Server)

## Clearing the Event Log
ELsave – command-line log clearing tool
- Written for Windows NT


##  Hiding Files
Attrib +h filename
- Sets the Hidden bit, which hides files somewhat
Alternate Data Streams
-  Hide a file within a file
- A NT feature designed for compatibility with Macintosh

## Demonstration of ADS
![[2Semester/ETH/Images/63.png]]

## ADS With Binary Files
You need the POSIX cp utility (in the Resource Kit)
- To detect alternate data streams, use LADS or Foundstone’s SFIND
- To delete an ADS, copy the file to a FAT partition and then back to NTFS

 ```ad-example
![[2Semester/ETH/Images/64.png]]

```

## Rootkits
Rootkits are the best way to hide files, accounts, backdoors, network connections, etc. on a machine. More on rootkits in a dedicated chapter



## General Countermeasures to Authenticated Compromises
Once a system has been compromised with administrator privileges, you should just reinstall it completely. You can never be sure you really found and removed all the backdoors
But if you want to clean it, cover four areas: Files, Registry keys, Processes and Network ports

## Suspicious Files
- Known dangerous filenames like nc.exe
- Run antivirus software
- Use Tripwire or other tools that identify changes to system files

## Suspicious Registry Entries
Look for registry keys that start known backdoors like"
-  HKEY_USERS\.DEFAULT\Software\ ORL\WINVNC3
-  HKEY_LOCAL_MACHINE\SOFTWARE\ Net Solutions\NetBus Server

> Use reg delete to remove them

## A Back-Door Favorite: Autostart Extensibility Points (ASEPs)
![[2Semester/ETH/Images/65.png]]


## Suspicious Processes
Malicious process with CPU utilization
- End process or kill to stop 
- Check scheduler queue: schtasks, task scheduler

## Suspicious Ports
Use netstat -aon to view network connections
![[2Semester/ETH/Images/66.png]]

## Windows Security Features
Group Policy tool
- Allows security policy settings in domains
Microsoft Security Essentials
- Free antivirus, included in Win 8 by default
EMET (Enhanced Mitigation Experience Toolkit)
-  Allows the user to configure DEP (Data Execution Prevention) and ASLR (Address Space Layout Randomization)

Encryption methods like BitLocker and Encrypting File System (EFS) provide security. EFS works by encrypting the symmetric key with the user's public key and storing it as an attribute of the file; the symmetric key is decrypted by the private key before decrypting the file. These methods offer protection from booting alternative OS and from files on remote servers. However, there are concerns such as recovery agents and privacy issues when employees leave the organization. The primary vulnerability is the Recovery Agent account.

EFS encrypts folders, and in Windows 2000 and Server 2003, the Local Administrator account was set as the Default Recovery Agent, which was a serious security hole, but this was fixed starting with Windows XP. BitLocker encrypts the whole hard drive, and in Windows 7, BitLocker To Go can encrypt removable USB devices.

## Least Privilege
Most Windows users use an Administrative account all the time
Many Win Services run under Administrative privileges
-  Very poor for security, but convenient
- For XP, 2003, and earlier: log on as a limited user, use run as to elevate privileges as needed

## Windows Security Features
Ecco un riassunto dei punti principali:

1. **Windows Firewall**: Impiega la metafora dell'“eccezione” per le applicazioni permesse, bloccando per impostazione predefinita tutte le connessioni in entrata.
2. **Aggiornamenti automatizzati**: Gestisce gli aggiornamenti di sicurezza in modo automatico.
3. **Security Center**: Destinato ai consumatori, non ai professionisti IT.
4. **Security Policy e Group Policy**: Gestisce la sicurezza su computer singoli o un numero elevato di sistemi.
5. **Microsoft Security Essentials**: Fornisce protezione in tempo reale, scansioni di sistema, protezione contro i rootkit, ispezione di rete e aggiornamenti automatici.
6. **The Enhanced Mitigation Experience Toolkit**: Gestisce le tecnologie di mitigazione come DEP (Data Execution Prevention) e ASLR (Address Space Layout Randomization).
7. **Bitlocker e EFS (Encryption File System)**:
    - EFS: Usa una chiave simmetrica crittografata con la chiave pubblica dell'utente per proteggere i file.
    - Bitlocker: Crittografa l'intero volume e conserva la chiave in modo sicuro.
    - **Attacco Cold Boot**: Si sfrutta il raffreddamento dei chip DRAM per estendere il tempo di vita della chiave in memoria volatile. Le contromisure includono separare fisicamente la chiave o usare un modulo esterno rimovibile.
8. **Windows Resource Protection (WRP)**: Protegge file e valori del registro da modifiche tramite ACL.
9. **Data Execution Prevention (DEP)**: Impedisce gli attacchi di overflow del buffer marcare alcune porzioni di memoria come non eseguibili.
10. **Windows service hardening**: Isolamento delle risorse dei servizi, utilizzo del principio del minimo privilegio, isolamento della rete e isolamento della sessione 0.
11. **Compiler-based enhancements**: Funzioni di sicurezza compile-time come il controllo del buffer (GS), ASLR e SafeSEH, non configurabili dagli amministratori o dagli utenti.